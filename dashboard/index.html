<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ANTIGRAVITY: v5.71 UNIFIED MANIFOLD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-deep: #0a0a0c;
            --bg-card: #141417;
            --accent-main: #00ffcc;
            --accent-second: #bb86fc;
            --text-main: #e0e0e0;
            --text-dim: #909090;
            --border: #26262b;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 10px 20px;
            background: rgba(20, 20, 23, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .highlight {
            color: var(--accent-main);
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1.2fr;
            gap: 10px;
            padding: 10px;
            flex-grow: 1;
            overflow: hidden;
            min-height: 0;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .card.flex-2 {
            flex: 2;
        }

        .card.flex-1 {
            flex: 1;
        }

        .card.flex-3 {
            flex: 3;
        }

        /* Voter Map specific styles */
        .voter-layer {
            margin-bottom: 14px;
            flex-shrink: 0;
        }

        .voter-layer-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 4px;
        }

        .voter-layer-pct {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-main);
        }

        .voter-layer-map {
            font-family: monospace;
            font-size: 1.05rem;
            letter-spacing: 2px;
            color: var(--accent-main);
            background: #000;
            padding: 6px 8px;
            border-radius: 4px;
            overflow-x: hidden;
            white-space: nowrap;
            border: 1px solid #1a1a20;
        }

        .voter-layer-count {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .card h2 {
            margin: 0 0 5px 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .chart-box {
            flex-grow: 1;
            position: relative;
            min-height: 0;
            width: 100%;
        }

        .log-box {
            flex: 1;
            background: #000;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            padding: 8px;
            border-radius: 4px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #aaa;
            border: 1px solid #1a1a1d;
            min-height: 0;
        }

        .value-display {
            font-size: 1.6rem;
            /* Slightly smaller to fit 5 digits */
            font-weight: bold;
            color: var(--accent-main);
            line-height: 1.2;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            text-align: center;
            margin-bottom: 5px;
            flex-shrink: 0;
            padding: 0 5px;
        }

        .metric-item {
            flex: 1;
            min-width: 0;
            /* Allow shrinking */
        }

        .metric-item small {
            display: block;
            color: var(--text-dim);
            font-size: 0.6rem;
            text-transform: uppercase;
            margin-top: 2px;
            white-space: nowrap;
        }
    </style>
</head>

<body>

    <header>
        <h1>ANTIGRAVITY <span class="highlight">v5.71</span> // UNIFIED MANIFOLD</h1>
        <div style="font-size: 0.75rem; color: var(--text-dim);">0.1B Scale Monitor</div>
    </header>

    <div class="main-grid">
        <!-- Left Column -->
        <div class="col">
            <!-- Main Loss Chart -->
            <div class="card flex-2">
                <h2>Training Dynamics <span>Loss & Entropy</span></h2>
                <div class="chart-box"><canvas id="lossChart"></canvas></div>
            </div>

            <!-- Word Salad Panel -->
            <div class="card flex-1">
                <h2>Word Salad Test <span>v5.71 16-bit Manifold</span></h2>
                <div class="log-box" id="word-salad"
                    style="font-size: 0.85rem; color: #00ffcc; border: 1px solid #336655;">Waiting for generation...
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col">
            <!-- Real-Time Metrics -->
            <div class="card flex-1">
                <h2>Instant Metrics</h2>
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="value-display" id="loss-val">--</div>
                        <small>Loss</small>
                    </div>
                    <div class="metric-item">
                        <div class="value-display" id="tps-val">--</div>
                        <small>Tokens/Sec</small>
                    </div>
                    <div class="metric-item">
                        <div class="value-display" id="flips-val">--</div>
                        <small>Bit Flips</small>
                    </div>
                </div>
                <!-- Row 2: Telemetry Sensors (v5.73) -->
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="value-display" id="stride-val" style="color: #bb86fc;">--</div>
                        <small>Avg Stride</small>
                    </div>
                    <div class="metric-item">
                        <div class="value-display" id="max-stride-val" style="color: #bb86fc;">--</div>
                        <small>Max Inst. Stride</small>
                    </div>
                </div>
                <div class="chart-box"><canvas id="metricChart"></canvas></div>
            </div>

            <!-- Perplexity -->
            <div class="card flex-1">
                <h2>Perplexity Log <span id="ppl-val" style="color: #bb86fc;">--</span></h2>
                <div class="chart-box"><canvas id="pplChart"></canvas></div>
            </div>

            <!-- Night Shift Supervisor -->
            <div class="card flex-1">
                <h2>Night Shift Supervisor <span>Dynamic Supermajority Clutch</span></h2>
                <div style="padding: 5px; color: #0f0; font-family: monospace; font-size: 0.85rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Core Consensus Gear:</span>
                        <span id="gear-display" style="font-size: 1.2rem; font-weight: bold;">20</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Starvation Patience:</span>
                        <span id="patience-display">0</span>
                    </div>
                    <div id="gear-status"
                        style="text-align: center; border: 1px solid #333; padding: 4px; border-radius: 4px; background: #000; margin-top: 5px; font-size: 0.75rem;">
                        Status: NOMINAL (BASELINE)
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card flex-1">
                <h2>Terminal Output</h2>
                <div class="log-box" id="terminal">Waiting for logs...</div>
            </div>
        </div>

        <!-- Voter Map Column (full height, own column) -->
        <div class="col">
            <div class="card" style="flex: 1;">
                <h2>Manifold Voter Map <span>Layer Consensus</span></h2>
                <div id="voter-map-container" style="flex: 1; overflow-y: auto; padding: 4px;">
                    <div style="color: var(--text-dim); font-size: 0.8rem;">Initializing maps...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const commonOpts = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                y: { grid: { color: '#1a1a1d' }, ticks: { color: '#666', font: { size: 10 } } },
                x: { grid: { display: false }, ticks: { color: '#666', font: { size: 10 } } }
            },
            plugins: { legend: { labels: { color: '#999', boxWidth: 10, font: { size: 10 } } } }
        };

        const lossChart = new Chart(document.getElementById('lossChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [], datasets: [
                    { label: 'Loss', borderColor: '#00ffcc', data: [], borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: 'y' },
                    { label: 'Entropy', borderColor: '#ff00cc', data: [], borderWidth: 1, pointRadius: 0, tension: 0.4, yAxisID: 'y1' }
                ]
            },
            options: {
                ...commonOpts,
                scales: {
                    ...commonOpts.scales,
                    y1: { position: 'right', grid: { display: false }, ticks: { color: '#444' } }
                }
            }
        });

        const metricChart = new Chart(document.getElementById('metricChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [], datasets: [
                    { label: 'Bit Flips %', borderColor: '#ffff00', data: [], borderWidth: 1, pointRadius: 0 },
                    { label: 'TPS', borderColor: '#444444', data: [], borderWidth: 1, pointRadius: 0, borderDash: [2, 2] }
                ]
            },
            options: commonOpts
        });

        const pplChart = new Chart(document.getElementById('pplChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [], datasets: [
                    { label: 'Perplexity', borderColor: '#bb86fc', data: [], borderWidth: 2, pointRadius: 0, tension: 0.4 }
                ]
            },
            options: commonOpts
        });

        async function update() {
            try {
                // Fetch Stats
                const statsResponse = await fetch('/api/stats/project_real');
                const data = await statsResponse.json();

                if (data && data.length > 0) {
                    const steps = data.map(d => d.step);
                    const loss = data.map(d => d.loss);
                    const entropy = data.map(d => d.entropy);
                    const flips = data.map(d => d.flips);
                    const tps = data.map(d => d.tps);

                    // Update Loss Chart
                    lossChart.data.labels = steps;
                    lossChart.data.datasets[0].data = loss;
                    lossChart.data.datasets[1].data = entropy;
                    lossChart.update('none');

                    // Update Metric Chart
                    metricChart.data.labels = steps;
                    metricChart.data.datasets[0].data = flips;
                    metricChart.data.datasets[1].data = tps;
                    metricChart.update('none');

                    // Update Text Metrics
                    const latest = data[data.length - 1];
                    document.getElementById('loss-val').innerText = (latest.loss !== null) ? latest.loss.toFixed(4) : "NaN";
                    document.getElementById('tps-val').innerText = (latest.tps !== null) ? Math.round(latest.tps) : "--";
                    document.getElementById('flips-val').innerText = (latest.flips !== null) ? latest.flips.toFixed(4) + '%' : "--%";

                    // v5.73 Telemetry
                    document.getElementById('stride-val').innerText = (latest.avg_stride !== undefined && latest.avg_stride !== null) ? latest.avg_stride.toFixed(4) : "--";
                    document.getElementById('max-stride-val').innerText = (latest.max_stride !== undefined && latest.max_stride !== null) ? latest.max_stride : "--";
                }

                // Fetch Logs
                const logsResponse = await fetch('/api/logs/project_real');
                const logsData = await logsResponse.json();
                const terminal = document.getElementById('terminal');
                if (logsData.logs) {
                    const isScrolledToBottom = terminal.scrollHeight - terminal.clientHeight <= terminal.scrollTop + 10;
                    if (terminal.innerText !== logsData.logs) {
                        terminal.innerText = logsData.logs;
                        if (isScrolledToBottom) {
                            terminal.scrollTop = terminal.scrollHeight;
                        }
                    }
                }

                // Fetch Word Salad Test
                const saladResponse = await fetch('/api/samples/project_real');
                const saladData = await saladResponse.json();
                if (saladData && saladData.length > 0) {
                    const latestSample = saladData[saladData.length - 1];
                    const saladEl = document.getElementById('word-salad');
                    saladEl.innerText = `[Step ${latestSample.step}]\n${latestSample.text}`;
                    saladEl.scrollTop = saladEl.scrollHeight;
                }

                // Fetch Perplexity
                const pplResponse = await fetch('/api/perplexity/project_real');
                const pplData = await pplResponse.json();
                if (pplData && pplData.length > 0) {
                    const steps = pplData.map(d => d.step);
                    const vals = pplData.map(d => d.perplexity);
                    pplChart.data.labels = steps;
                    pplChart.data.datasets[0].data = vals;
                    pplChart.update('none');
                    document.getElementById('ppl-val').innerText = vals[vals.length - 1].toFixed(2);
                }

                // Fetch Voter Map
                const mapResponse = await fetch('/api/voter_map');
                const mapData = await mapResponse.json();
                if (mapData && mapData.length > 0) {
                    const mapContainer = document.getElementById('voter-map-container');
                    mapContainer.innerHTML = '';
                    mapData.forEach(layer => {
                        const pct = parseFloat(layer.active_pct);
                        // Color-code by activity level
                        const color = pct > 10 ? '#00ffcc' : pct > 1 ? '#ffcc00' : '#cc4444';
                        const layerDiv = document.createElement('div');
                        layerDiv.className = 'voter-layer';
                        layerDiv.innerHTML = `
                            <div class="voter-layer-header">
                                <span>${layer.layer}</span>
                                <span class="voter-layer-pct" style="color:${color}">${layer.active_pct}%</span>
                            </div>
                            <div class="voter-layer-map" style="color:${color}">${layer.map}</div>
                            <div class="voter-layer-count">${layer.active_count?.toLocaleString() ?? '?'} / ${layer.num_blocks?.toLocaleString() ?? '?'} precincts active</div>
                        `;
                        mapContainer.appendChild(layerDiv);
                    });
                }
            } catch (e) {
                console.error("Dashboard Update Error:", e);
            }
        }

        async function pollSupervisor() {
            try {
                const response = await fetch('/api/supervisor');
                const data = await response.json();

                const gearDisplay = document.getElementById('gear-display');
                const statusDisplay = document.getElementById('gear-status');

                gearDisplay.innerText = data.current_threshold;
                document.getElementById('patience-display').innerText = data.starvation_patience;

                // Visual indicators for the state machine
                if (data.current_threshold < 20) {
                    gearDisplay.style.color = "#00ffff"; // Cyan for relaxed/downshifted
                    statusDisplay.innerText = "Status: FINE-TUNING (RELAXED)";
                    statusDisplay.style.color = "#00ffff";
                    statusDisplay.style.borderColor = "#00ffff";
                } else if (data.current_threshold > 20) {
                    gearDisplay.style.color = "#ff3333"; // Red for locked-down/upshifted
                    statusDisplay.innerText = "Status: EMERGENCY LOCKDOWN (UPSHIFTED)";
                    statusDisplay.style.color = "#ff3333";
                    statusDisplay.style.borderColor = "#ff3333";
                } else {
                    gearDisplay.style.color = "#0f0"; // Green for baseline
                    statusDisplay.innerText = "Status: NOMINAL (BASELINE)";
                    statusDisplay.style.color = "#0f0";
                    statusDisplay.style.borderColor = "#333";
                }
            } catch (error) {
                console.error("Supervisor telemetry offline.", error);
            }
        }

        setInterval(update, 1000);
        setInterval(pollSupervisor, 2000);
        update();
        pollSupervisor();
    </script>

</body>

</html>